# 老板评分工作流程文档

## 概述

本文档详细描述了老板(Boss)在OKR绩效考核系统中的**简化评分工作流程**，包括待办查看、评分操作和结果查看的完整流程。

**重要特性**：
- **简化评分模式**：老板评分采用简化模式，只需提供总分和评语，无需逐项详细评分
- **两层加权支持**：在两层加权模式下，老板可对任何已完成自评和领导评分的员工进行最终评分
- **全局查看权限**：老板可以查看任何员工的评分对比和完整评估详情

## 前提条件

- 老板账号已登录系统
- 考核配置为**两层加权模式**（`scoring_mode: "two_tier_weighted"`）
- 考核状态为 `active`（进行中）
- 员工已完成自评，领导已完成评分

## 完整工作流程

### 1. 查看待办任务

**接口**: `GET /api/v1/evaluations/my-tasks`

**参数**:
- `assessment_id` (可选): 指定考核ID，不传则返回所有考核的任务

**返回数据**:
```json
[
  {
    "id": "boss-17-7",
    "assessment_id": 17,
    "assessment_title": "2024年第4季度绩效考核",
    "assessment_period": "2024年第4季度",
    "type": "boss",
    "evaluatee_id": 7,
    "evaluatee_name": "张三",
    "evaluatee_department": "技术部",
    "status": "pending",
    "deadline": "2025-01-15T23:59:59.000Z",
    "is_overdue": false,
    "evaluation_id": null,
    "last_updated": null
  }
]
```

**任务状态说明**:
- `pending`: 待开始
- `in_progress`: 进行中（已保存草稿）
- `completed`: 已完成

### 2. 获取特定考核的下属评分任务

**接口**: `GET /api/v1/evaluations/subordinates/{assessmentId}`

**参数**:
- `assessmentId`: 考核ID

**返回数据**:
```json
[
  {
    "subordinate_id": 7,
    "subordinate_name": "张三",
    "subordinate_department": "技术部",
    "status": "not_started",
    "self_evaluation_completed": true,
    "self_evaluation_completed_at": "2025-07-27T23:56:23.000Z",
    "leader_evaluation_id": 17,
    "leader_evaluation_completed_at": "2025-07-28T00:28:10.000Z",
    "last_updated": "2025-07-28T00:28:10.000Z"
  }
]
```

### 3. 获取评分模板（简化模式）

**接口**: `GET /api/v1/evaluations/template/{assessmentId}/user/{userId}`

**参数**:
- `assessmentId`: 考核ID
- `userId`: 被评估人ID

**返回数据示例**:
```json
{
  "code": 200,
  "message": "success", 
  "data": {
    "assessment_id": 17,
    "assessment_title": "2025年05月绩效考核",
    "version": "1.0",
    "scoring_method": "weighted",
    "total_score": 100,
    "scoring_rules": {
      "scoring_mode": "two_tier_weighted",
      "two_tier_config": {
        "boss_weight": 10,
        "employee_leader_weight": 90,
        "self_weight_in_employee_leader": 40,
        "leader_weight_in_employee_leader": 60
      },
      "calculation_method": "weighted_average"
    },
    "categories": [],
    "usage_instructions": {
      "for_leaders": [],
      "for_employees": []
    },
    "current_user_id": 2,
    "evaluation_type": "boss",
    "evaluatee_id": 7,
    "evaluatee_name": "张三",
    "current_status": "not_started",
    "is_boss_simplified": true,
    "boss_evaluation_note": "老板评分采用简化模式，只需提供总分和简要评语即可"
  }
}
```

**关键特征**:
- `categories`: **空数组**，表示无需详细项目评分
- `is_boss_simplified`: **true**，标识简化评分模式  
- `boss_evaluation_note`: 提供操作说明
- `evaluation_type`: "boss"，确认评分类型

### 4. 提交简化评分（推荐）

老板评分采用**简化模式**，只需提供总分和评语，无需逐项详细评分。

**接口**: `POST /api/v1/evaluations/boss`

**请求体**:
```json
{
  "assessment_id": 17,
  "evaluatee_id": 7,
  "score": 88.5,
  "feedback": "整体表现良好，在技术能力方面有显著提升，建议继续保持工作积极性"
}
```

**字段说明**:
- `assessment_id`: 考核ID（必填）
- `evaluatee_id`: 被评估人ID（必填） 
- `score`: 总分，0-100之间（必填）
- `feedback`: 评语（可选但推荐填写）
- `strengths`: 优势（可选）
- `improvements`: 改进建议（可选）

**返回结果**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 18,
    "assessment_id": 17,
    "evaluatee_id": 7,
    "evaluator_id": 2,
    "type": "boss",
    "score": "88.50",
    "feedback": "整体表现良好，在技术能力方面有显著提升",
    "strengths": null,
    "improvements": null,
    "detailed_scores": null,
    "status": "submitted",
    "submitted_at": "2025-07-28T08:45:00.000Z"
  }
}
```

**注意事项**:
- `detailed_scores` 始终为 `null`，符合简化评分逻辑
- 评分提交后将触发最终分数的两层加权计算
- 系统会自动检查员工的自评和领导评分完成状态

### 5. 查看评分详情

**接口**: `GET /api/v1/evaluations/detailed/{evaluationId}`

**参数**:
- `evaluationId`: 评估记录ID

### 6. 查看评分对比（全局权限）

**接口**: `GET /api/v1/evaluations/comparison/{assessmentId}/{userId}`

**参数**:
- `assessmentId`: 考核ID
- `userId`: 被评估人ID

**权限说明**:
- **老板具有全局查看权限**：在两层加权模式下，老板可以查看任何员工的评分对比
- 员工只能查看自己的评分对比
- 领导可以查看直属下属的评分对比

**返回数据示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "assessment_id": 17,
    "user_id": 7,
    "self_evaluation": {
      "id": 16,
      "type": "self",
      "score": "98.36",
      "feedback": "工作表现良好，积极完成各项任务",
      "detailed_scores_with_template": [
        {
          "categoryName": "工作绩效",
          "categoryScore": 98.4,
          "items": [
            {
              "itemName": "工作饱和度",
              "score": 99,
              "comment": "工作饱和度良好"
            }
          ]
        }
      ]
    },
    "leader_evaluation": {
      "id": 17,
      "type": "leader",  
      "score": "88.04",
      "feedback": "整体表现符合预期",
      "detailed_scores_with_template": [
        {
          "categoryName": "工作绩效",
          "categoryScore": 88.0,
          "items": [
            {
              "itemName": "工作饱和度",
              "score": 80,
              "comment": "需要提升工作饱和度"
            }
          ]
        }
      ]
    },
    "boss_evaluation": {
      "id": 18,
      "type": "boss",
      "score": "88.50",
      "feedback": "整体表现良好，工作积极主动",
      "strengths": null,
      "improvements": null,
      "detailed_scores_with_template": null
    },
    "evaluation_status": {
      "is_completed": true,
      "completion_status": "completed",
      "has_self_evaluation": true,
      "has_leader_evaluation": true,
      "has_boss_evaluation": true,
      "boss_enabled": true,
      "scoring_mode": "two_tier_weighted",
      "current_score": 91.8,
      "score_breakdown": {
        "self_score": 98.36,
        "leader_score": 88.04,
        "boss_score": 88.5,
        "weighted_self_score": 35.41,
        "weighted_leader_score": 47.54,
        "weighted_boss_score": 8.85
      },
      "weight_config": {
        "self_weight": 0.36,
        "leader_weight": 0.54,
        "boss_weight": 0.1,
        "boss_enabled": true
      }
    },
    "comparison_analysis": {
      "self_vs_leader": {
        "score_difference": 10.32,
        "self_higher": true,
        "agreement_level": "low"
      }
    }
  }
}
```

**关键特征**:
- `boss_evaluation.detailed_scores_with_template`: **null**，体现简化评分模式
- `evaluation_status.scoring_mode`: "two_tier_weighted"，确认两层加权模式
- `score_breakdown`: 清晰显示各评分的权重贡献
- `current_score`: 91.8，最终加权分数

### 7. 查看完整评估详情

**接口**: `GET /api/v1/evaluations/assessment/{assessmentId}/user/{userId}/complete`

**权限要求**: 需要 `leader`、`boss` 或 `admin` 角色

**查询参数**:
- `include_details`: 是否包含详细评分项（默认true）
- `include_comments`: 是否包含评论内容（默认true）
- `include_comparison`: 是否包含对比分析（默认true）

## 评分计算逻辑

### 两层加权模式
当老板评分完成后，系统会根据配置的权重计算最终得分：

```
最终得分 = Boss评分 × Boss权重 + (自评得分 × 自评权重 + 领导评分 × 领导权重) × 员工+领导权重
```

**默认配置**:
- Boss权重: 10%
- 员工+领导权重: 90%
  - 自评在员工+领导中的权重: 40%
  - 领导评分在员工+领导中的权重: 60%

**实际计算**:
- 自评最终权重: 40% × 90% = 36%
- 领导评分最终权重: 60% × 90% = 54%
- Boss评分最终权重: 10%

### 传统模式
如果未启用Boss评分，则使用传统的两阶段评分：
```
最终得分 = 自评得分 × 自评权重 + 领导评分 × 领导权重
```

## 工作流程步骤总结

1. **登录系统** → 老板账号登录
2. **查看待办** → `GET /api/v1/evaluations/my-tasks`
3. **查看下属列表** → `GET /api/v1/evaluations/subordinates/{assessmentId}`
4. **获取简化评分模板** → `GET /api/v1/evaluations/template/{assessmentId}/user/{userId}`
5. **提交简化评分** → `POST /api/v1/evaluations/boss`
6. **查看结果对比** → `GET /api/v1/evaluations/comparison/{assessmentId}/{userId}`
7. **查看完整详情** → `GET /api/v1/evaluations/assessment/{assessmentId}/user/{userId}/complete`

## 简化评分模式特点

### 🎯 核心理念
老板评分采用**高级管理视角**，注重整体表现评估，而非细节项目评分：

1. **时间效率**：老板时间宝贵，无需逐项详细评分
2. **战略高度**：从公司整体角度评估员工贡献  
3. **简化操作**：只需总分+评语，操作简单高效
4. **权重平衡**：10%权重影响最终结果，起到调节作用

### 📊 技术实现
- **模板简化**：`categories` 返回空数组
- **标识字段**：`is_boss_simplified: true`
- **数据结构**：`detailed_scores` 始终为 `null`
- **权限扩展**：老板可查看任何员工的评分对比

## 注意事项

### ✅ 权限和安全
1. **双重验证**：系统验证老板角色 + 两层加权模式
2. **状态检查**：只能对 `active` 状态考核进行评分
3. **依赖检查**：自动验证员工自评和领导评分完成状态
4. **全局权限**：老板可查看任何员工的评分对比和完整详情

### ⚡ 业务逻辑
1. **即时计算**：Boss评分提交后立即触发最终得分计算
2. **权重应用**：采用两层加权公式自动计算最终分数
3. **状态更新**：自动更新考核和参与者状态
4. **时区处理**：所有时间均为东八区，API返回正确时区转换

### 🔄 流程优化
1. **无需详细评分**：直接提供总分和评语即可
2. **批量处理**：可快速处理多个员工的评分
3. **结果透明**：员工可查看老板评分及权重分解
4. **历史追溯**：完整记录评分时间线和操作历史

## 错误处理

常见错误响应：

- `400 Bad Request`: 参数错误或业务规则错误
- `403 Forbidden`: 权限不足，不是该员工的上级
- `404 Not Found`: 考核或用户不存在
- `401 Unauthorized`: 未登录或token过期

## API调用示例

```bash
# 1. 老板登录获取token
curl -X POST "http://localhost:3010/api/v1/auth/login" \
     -H "Content-Type: application/json" \
     -d '{
       "username": "boss",
       "password": "123456"
     }'

# 2. 获取待办任务  
curl -X GET "http://localhost:3010/api/v1/evaluations/my-tasks?assessment_id=17" \
     -H "Authorization: Bearer {boss_token}"

# 3. 获取简化评分模板
curl -X GET "http://localhost:3010/api/v1/evaluations/template/17/user/7" \
     -H "Authorization: Bearer {boss_token}"

# 4. 提交简化评分
curl -X POST "http://localhost:3010/api/v1/evaluations/boss" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {boss_token}" \
     -d '{
       "assessment_id": 17,
       "evaluatee_id": 7,
       "score": 88.5,
       "feedback": "整体表现良好，工作积极主动，建议继续保持"
     }'

# 5. 查看评分对比（老板全局权限）
curl -X GET "http://localhost:3010/api/v1/evaluations/comparison/17/7" \
     -H "Authorization: Bearer {boss_token}"

# 6. 查看完整评估详情
curl -X GET "http://localhost:3010/api/v1/evaluations/assessment/17/user/7/complete?include_details=true&include_comparison=true" \
     -H "Authorization: Bearer {boss_token}"

# 7. 查看员工最终结果（员工视角）
curl -X GET "http://localhost:3010/api/v1/evaluations/my-result/17" \
     -H "Authorization: Bearer {employee_token}"
```

## 完整测试流程

### 场景：老板为员工张三（ID: 7）完成绩效评分

```bash
# Step 1: 老板登录
BOSS_TOKEN=$(curl -s -X POST "http://localhost:3010/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "boss", "password": "123456"}' | \
  jq -r '.data.access_token')

# Step 2: 查看待办任务
echo "=== 老板待办任务 ==="
curl -s -X GET "http://localhost:3010/api/v1/evaluations/my-tasks" \
  -H "Authorization: Bearer $BOSS_TOKEN" | jq '.data[]'

# Step 3: 获取评分模板（验证简化模式）
echo "=== 评分模板（简化模式）==="
curl -s -X GET "http://localhost:3010/api/v1/evaluations/template/17/user/7" \
  -H "Authorization: Bearer $BOSS_TOKEN" | \
  jq '.data | {is_boss_simplified, categories, boss_evaluation_note}'

# Step 4: 提交评分
echo "=== 提交老板评分 ==="
curl -s -X POST "http://localhost:3010/api/v1/evaluations/boss" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOSS_TOKEN" \
  -d '{
    "assessment_id": 17,
    "evaluatee_id": 7,
    "score": 88.5,
    "feedback": "从公司整体角度来看，该员工表现符合预期，具备良好的工作态度和执行能力"
  }' | jq '.data | {id, score, feedback, detailed_scores}'

# Step 5: 查看最终评分对比
echo "=== 评分对比结果 ==="
curl -s -X GET "http://localhost:3010/api/v1/evaluations/comparison/17/7" \
  -H "Authorization: Bearer $BOSS_TOKEN" | \
  jq '.data.evaluation_status | {current_score, score_breakdown, weight_config}'
```

### 预期结果验证

✅ **简化模式标识**：
- `is_boss_simplified: true`
- `categories: []`
- `boss_evaluation_note` 包含操作说明

✅ **评分数据结构**：
- `boss_evaluation.detailed_scores: null`
- `boss_evaluation.feedback` 包含总体评语
- 无详细项目评分数据

✅ **最终分数计算**：
- 使用两层加权公式：`final_score = self × 36% + leader × 54% + boss × 10%`
- `current_score` 显示正确的加权结果
- `score_breakdown` 明确展示各部分贡献